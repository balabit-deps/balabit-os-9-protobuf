Backport of:

From: Protobuf Team Bot <protobuf-github-bot@google.com>
Date: Fri, 16 Aug 2024 16:57:47 -0700
Subject: [PATCH 1/5] Internal change

PiperOrigin-RevId: 663919912
---
 .../com/google/protobuf/CodedInputStream.java | 106 ++++--------------
 .../com/google/protobuf/map_lite_test.proto   |   3 +-
 .../proto/com/google/protobuf/map_test.proto  |   3 +-
 .../java/com/google/protobuf/LiteTest.java    |   1 +
 4 files changed, 29 insertions(+), 84 deletions(-)

Index: protobuf-3.12.4/java/core/src/main/java/com/google/protobuf/CodedInputStream.java
===================================================================
--- protobuf-3.12.4.orig/java/core/src/main/java/com/google/protobuf/CodedInputStream.java
+++ protobuf-3.12.4/java/core/src/main/java/com/google/protobuf/CodedInputStream.java
@@ -245,13 +245,35 @@ public abstract class CodedInputStream {
    * Reads and discards an entire message. This will read either until EOF or until an endgroup tag,
    * whichever comes first.
    */
-  public abstract void skipMessage() throws IOException;
+  public void skipMessage() throws IOException {
+    while (true) {
+      final int tag = readTag();
+      if (tag == 0) {
+        return;
+      }
+      boolean fieldSkipped = skipField(tag);
+      if (!fieldSkipped) {
+        return;
+      }
+    }
+  }
 
   /**
    * Reads an entire message and writes it to output in wire format. This will read either until EOF
    * or until an endgroup tag, whichever comes first.
    */
-  public abstract void skipMessage(CodedOutputStream output) throws IOException;
+  public void skipMessage(CodedOutputStream output) throws IOException {
+    while (true) {
+      final int tag = readTag();
+      if (tag == 0) {
+        return;
+      }
+      boolean fieldSkipped = skipField(tag, output);
+      if (!fieldSkipped) {
+        return;
+      }
+    }
+  }
 
 
   // -----------------------------------------------------------------
@@ -724,27 +746,6 @@ public abstract class CodedInputStream {
       }
     }
 
-    @Override
-    public void skipMessage() throws IOException {
-      while (true) {
-        final int tag = readTag();
-        if (tag == 0 || !skipField(tag)) {
-          return;
-        }
-      }
-    }
-
-    @Override
-    public void skipMessage(CodedOutputStream output) throws IOException {
-      while (true) {
-        final int tag = readTag();
-        if (tag == 0 || !skipField(tag, output)) {
-          return;
-        }
-      }
-    }
-
-
     // -----------------------------------------------------------------
 
     @Override
@@ -1430,27 +1431,6 @@ public abstract class CodedInputStream {
       }
     }
 
-    @Override
-    public void skipMessage() throws IOException {
-      while (true) {
-        final int tag = readTag();
-        if (tag == 0 || !skipField(tag)) {
-          return;
-        }
-      }
-    }
-
-    @Override
-    public void skipMessage(CodedOutputStream output) throws IOException {
-      while (true) {
-        final int tag = readTag();
-        if (tag == 0 || !skipField(tag, output)) {
-          return;
-        }
-      }
-    }
-
-
     // -----------------------------------------------------------------
 
     @Override
@@ -2149,26 +2129,6 @@ public abstract class CodedInputStream {
       }
     }
 
-    @Override
-    public void skipMessage() throws IOException {
-      while (true) {
-        final int tag = readTag();
-        if (tag == 0 || !skipField(tag)) {
-          return;
-        }
-      }
-    }
-
-    @Override
-    public void skipMessage(CodedOutputStream output) throws IOException {
-      while (true) {
-        final int tag = readTag();
-        if (tag == 0 || !skipField(tag, output)) {
-          return;
-        }
-      }
-    }
-
     /** Collects the bytes skipped and returns the data in a ByteBuffer. */
     private class SkippedDataSink implements RefillCallback {
       private int lastPos = pos;
@@ -3263,26 +3223,6 @@ public abstract class CodedInputStream {
       }
     }
 
-    @Override
-    public void skipMessage() throws IOException {
-      while (true) {
-        final int tag = readTag();
-        if (tag == 0 || !skipField(tag)) {
-          return;
-        }
-      }
-    }
-
-    @Override
-    public void skipMessage(CodedOutputStream output) throws IOException {
-      while (true) {
-        final int tag = readTag();
-        if (tag == 0 || !skipField(tag, output)) {
-          return;
-        }
-      }
-    }
-
     // -----------------------------------------------------------------
 
     @Override
Index: protobuf-3.12.4/java/core/src/test/proto/com/google/protobuf/map_lite_test.proto
===================================================================
--- protobuf-3.12.4.orig/java/core/src/test/proto/com/google/protobuf/map_lite_test.proto
+++ protobuf-3.12.4/java/core/src/test/proto/com/google/protobuf/map_lite_test.proto
@@ -119,3 +119,9 @@ message ReservedAsMapFieldWithEnumValue
   // null is not a 'reserved word' per se but as a literal needs similar care
   map<string, SampleEnum> null = 10;
 }
+
+// https://github.com/protocolbuffers/protobuf/issues/9785
+message MapContainer {
+  map<string, string> my_map = 1;
+  map<uint32, string> m = 3;
+}
\ No newline at end of file
Index: protobuf-3.12.4/java/core/src/test/proto/com/google/protobuf/map_test.proto
===================================================================
--- protobuf-3.12.4.orig/java/core/src/test/proto/com/google/protobuf/map_test.proto
+++ protobuf-3.12.4/java/core/src/test/proto/com/google/protobuf/map_test.proto
@@ -118,3 +118,9 @@ message ReservedAsMapFieldWithEnumValue
   // null is not a 'reserved word' per se but as a literal needs similar care
   map<string, SampleEnum> null = 10;
 }
+
+// https://github.com/protocolbuffers/protobuf/issues/9785
+message MapContainer {
+  map<string, string> my_map = 1;
+  map<uint32, string> m = 3;
+}
Index: protobuf-3.12.4/java/lite/src/test/java/com/google/protobuf/LiteTest.java
===================================================================
--- protobuf-3.12.4.orig/java/lite/src/test/java/com/google/protobuf/LiteTest.java
+++ protobuf-3.12.4/java/lite/src/test/java/com/google/protobuf/LiteTest.java
@@ -48,6 +48,7 @@ import com.google.protobuf.UnittestLite.
 import com.google.protobuf.UnittestLite.TestAllTypesLiteOrBuilder;
 import com.google.protobuf.UnittestLite.TestHugeFieldNumbersLite;
 import com.google.protobuf.UnittestLite.TestNestedExtensionLite;
+import map_lite_test.MapTestProto.MapContainer;
 import map_lite_test.MapTestProto.TestMap;
 import map_lite_test.MapTestProto.TestMap.MessageValue;
 import protobuf_unittest.NestedExtensionLite;
