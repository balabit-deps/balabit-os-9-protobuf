From 850fcce9176e2c9070614dab53537760498c926b Mon Sep 17 00:00:00 2001
From: Protobuf Team Bot <protobuf-github-bot@google.com>
Date: Thu, 18 Jul 2024 07:41:01 -0700
Subject: [PATCH 2/5] Internal change

PiperOrigin-RevId: 653615736
---
 .../core/src/main/java/com/google/protobuf/ArrayDecoders.java | 3 +--
 .../com/google/protobuf/InvalidProtocolBufferException.java   | 2 +-
 .../core/src/main/java/com/google/protobuf/MessageSchema.java | 3 +++
 .../src/main/java/com/google/protobuf/MessageSetSchema.java   | 1 +
 .../src/main/java/com/google/protobuf/UnknownFieldSchema.java | 3 +--
 java/lite/src/test/java/com/google/protobuf/LiteTest.java     | 3 +++
 src/google/protobuf/unittest_lite.proto                       | 4 ++++
 7 files changed, 14 insertions(+), 5 deletions(-)

Index: protobuf-3.12.4/java/core/src/main/java/com/google/protobuf/InvalidProtocolBufferException.java
===================================================================
--- protobuf-3.12.4.orig/java/core/src/main/java/com/google/protobuf/InvalidProtocolBufferException.java
+++ protobuf-3.12.4/java/core/src/main/java/com/google/protobuf/InvalidProtocolBufferException.java
@@ -124,7 +124,7 @@ public class InvalidProtocolBufferExcept
   static InvalidProtocolBufferException recursionLimitExceeded() {
     return new InvalidProtocolBufferException(
         "Protocol message had too many levels of nesting.  May be malicious.  "
-            + "Use CodedInputStream.setRecursionLimit() to increase the depth limit.");
+            + "Use setRecursionLimit() to increase the recursion depth limit.");
   }
 
   static InvalidProtocolBufferException sizeLimitExceeded() {
Index: protobuf-3.12.4/java/core/src/main/java/com/google/protobuf/MessageSchema.java
===================================================================
--- protobuf-3.12.4.orig/java/core/src/main/java/com/google/protobuf/MessageSchema.java
+++ protobuf-3.12.4/java/core/src/main/java/com/google/protobuf/MessageSchema.java
@@ -3904,6 +3904,7 @@ final class MessageSchema<T> implements
               unknownFields = unknownFieldSchema.getBuilderFromMessage(message);
             }
             // Unknown field.
+
             if (unknownFieldSchema.mergeOneFieldFrom(unknownFields, reader)) {
               continue;
             }
@@ -4306,6 +4307,7 @@ final class MessageSchema<T> implements
               if (unknownFields == null) {
                 unknownFields = unknownFieldSchema.newBuilder();
               }
+
               if (!unknownFieldSchema.mergeOneFieldFrom(unknownFields, reader)) {
                 return;
               }
@@ -4322,6 +4324,7 @@ final class MessageSchema<T> implements
             if (unknownFields == null) {
               unknownFields = unknownFieldSchema.getBuilderFromMessage(message);
             }
+
             if (!unknownFieldSchema.mergeOneFieldFrom(unknownFields, reader)) {
               return;
             }
Index: protobuf-3.12.4/java/core/src/main/java/com/google/protobuf/MessageSetSchema.java
===================================================================
--- protobuf-3.12.4.orig/java/core/src/main/java/com/google/protobuf/MessageSetSchema.java
+++ protobuf-3.12.4/java/core/src/main/java/com/google/protobuf/MessageSetSchema.java
@@ -290,6 +290,7 @@ final class MessageSetSchema<T> implemen
               reader, extension, extensionRegistry, extensions);
           return true;
         } else {
+
           return unknownFieldSchema.mergeOneFieldFrom(unknownFields, reader);
         }
       } else {
Index: protobuf-3.12.4/java/core/src/main/java/com/google/protobuf/UnknownFieldSchema.java
===================================================================
--- protobuf-3.12.4.orig/java/core/src/main/java/com/google/protobuf/UnknownFieldSchema.java
+++ protobuf-3.12.4/java/core/src/main/java/com/google/protobuf/UnknownFieldSchema.java
@@ -77,7 +77,6 @@ abstract class UnknownFieldSchema<T, B>
   /** Marks unknown fields as immutable. */
   abstract void makeImmutable(Object message);
 
-  /** Merges one field into the unknown fields. */
   final boolean mergeOneFieldFrom(B unknownFields, Reader reader) throws IOException {
     int tag = reader.getTag();
     int fieldNumber = WireFormat.getTagFieldNumber(tag);
@@ -110,7 +109,7 @@ abstract class UnknownFieldSchema<T, B>
     }
   }
 
-  final void mergeFrom(B unknownFields, Reader reader) throws IOException {
+  private final void mergeFrom(B unknownFields, Reader reader) throws IOException {
     while (true) {
       if (reader.getFieldNumber() == Reader.READ_DONE
           || !mergeOneFieldFrom(unknownFields, reader)) {
Index: protobuf-3.12.4/java/lite/src/test/java/com/google/protobuf/LiteTest.java
===================================================================
--- protobuf-3.12.4.orig/java/lite/src/test/java/com/google/protobuf/LiteTest.java
+++ protobuf-3.12.4/java/lite/src/test/java/com/google/protobuf/LiteTest.java
@@ -32,12 +32,14 @@ package com.google.protobuf;
 
 import static java.util.Collections.emptyList;
 import static java.util.Collections.singletonList;
+import static org.junit.Assert.assertThrows;
 
 import com.google.protobuf.FieldPresenceTestProto.TestAllTypes;
 import com.google.protobuf.UnittestImportLite.ImportEnumLite;
 import com.google.protobuf.UnittestImportPublicLite.PublicImportMessageLite;
 import com.google.protobuf.UnittestLite.ForeignEnumLite;
 import com.google.protobuf.UnittestLite.ForeignMessageLite;
+import com.google.protobuf.UnittestLite.RecursiveGroup;
 import com.google.protobuf.UnittestLite.TestAllExtensionsLite;
 import com.google.protobuf.UnittestLite.TestAllTypesLite;
 import com.google.protobuf.UnittestLite.TestAllTypesLite.NestedEnum;
@@ -68,6 +70,7 @@ import java.util.ArrayList;
 import java.util.Arrays;
 import java.util.Iterator;
 import java.util.List;
+import java.util.concurrent.atomic.AtomicBoolean;
 import junit.framework.TestCase;
 
 /**
Index: protobuf-3.12.4/src/google/protobuf/unittest_lite.proto
===================================================================
--- protobuf-3.12.4.orig/src/google/protobuf/unittest_lite.proto
+++ protobuf-3.12.4/src/google/protobuf/unittest_lite.proto
@@ -489,3 +489,7 @@ message DupEnum {
     BAR2 = 2;
   }
 }
+
+message RecursiveGroup {
+  RecursiveGroup recurse = 1 [features.message_encoding = DELIMITED];
+}
