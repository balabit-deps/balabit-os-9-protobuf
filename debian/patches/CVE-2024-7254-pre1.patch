Backport of:

From 562fc946c748d0ddb451ad1ce48570685f23a4f1 Mon Sep 17 00:00:00 2001
From: Adam Cozzette <acozzette@google.com>
Date: Tue, 3 Aug 2021 11:58:05 -0700
Subject: [PATCH] Sync from Piper @388508285

PROTOBUF_SYNC_PIPER
---
 .github/workflows/codespell.yml               |    4 +-
 .gitignore                                    |    1 -
 BUILD                                         |   36 +-
 CHANGES.txt                                   |   34 +-
 Protobuf.podspec                              |    2 +-
 WORKSPACE                                     |    4 +-
 benchmarks/README.md                          |    6 +-
 cmake/extract_includes.bat.in                 |    2 +
 cmake/tests.cmake                             |    2 +
 csharp/Google.Protobuf.Tools.nuspec           |    2 +-
 .../TestMessagesProto2.cs                     |  334 +-
 .../TestMessagesProto3.cs                     |  331 +-
 .../Google.Protobuf.Test/ByteStringTest.cs    |   16 +
 csharp/src/Google.Protobuf.Test/testprotos.pb |  Bin 340240 -> 340756 bytes
 csharp/src/Google.Protobuf/ByteString.cs      |    2 +-
 .../Google.Protobuf/Google.Protobuf.csproj    |    2 +-
 docs/field_presence.md                        |   72 +-
 docs/options.md                               |   10 +-
 java/BUILD                                    |   20 +-
 java/bom/pom.xml                              |    2 +-
 java/core/BUILD                               |   32 +-
 java/core/pom.xml                             |    2 +-
 java/core/pom_template.xml                    |   18 +
 .../com/google/protobuf/CodedInputStream.java |   73 +-
 .../java/com/google/protobuf/Descriptors.java |   11 +-
 .../java/com/google/protobuf/LazyField.java   |    8 +-
 .../com/google/protobuf/RawMessageInfo.java   |   28 +-
 .../google/protobuf/AbstractMessageTest.java  |  194 +-
 .../AbstractProto2LiteSchemaTest.java         |   37 +-
 .../protobuf/AbstractProto2SchemaTest.java    |   51 +-
 .../AbstractProto3LiteSchemaTest.java         |    8 +-
 .../protobuf/AbstractProto3SchemaTest.java    |   12 +-
 .../google/protobuf/AbstractSchemaTest.java   |   22 +-
 .../java/com/google/protobuf/AnyTest.java     |   50 +-
 .../google/protobuf/ArrayDecodersTest.java    |   49 +-
 .../google/protobuf/BinaryProtocolTest.java   |   15 +-
 .../google/protobuf/BooleanArrayListTest.java |  265 +-
 .../protobuf/BoundedByteStringTest.java       |   47 +-
 .../google/protobuf/ByteBufferWriterTest.java |   15 +-
 .../com/google/protobuf/ByteStringTest.java   |  419 +-
 .../google/protobuf/CachedFieldSizeTest.java  |    6 +-
 .../com/google/protobuf/CheckUtf8Test.java    |   73 +-
 .../com/google/protobuf/CodedAdapterTest.java |   12 +-
 .../google/protobuf/CodedInputStreamTest.java |  368 +-
 .../protobuf/CodedOutputStreamTest.java       |  207 +-
 .../google/protobuf/DeprecatedFieldTest.java  |   33 +-
 .../com/google/protobuf/DescriptorsTest.java  |  565 +--
 .../protobuf/DiscardUnknownFieldsTest.java    |   14 +-
 .../google/protobuf/DoubleArrayListTest.java  |  260 +-
 .../google/protobuf/DynamicMessageTest.java   |   85 +-
 .../java/com/google/protobuf/EnumTest.java    |   29 +-
 .../ExtensionRegistryFactoryTest.java         |  100 +-
 .../google/protobuf/FieldPresenceTest.java    |  316 +-
 .../google/protobuf/FloatArrayListTest.java   |  260 +-
 .../google/protobuf/GeneratedMessageTest.java |  788 ++--
 .../com/google/protobuf/IntArrayListTest.java |  260 +-
 .../com/google/protobuf/IsValidUtf8Test.java  |   57 +-
 .../google/protobuf/IsValidUtf8TestUtil.java  |   69 +-
 .../google/protobuf/LazyFieldLiteTest.java    |   85 +-
 .../com/google/protobuf/LazyFieldTest.java    |   51 +-
 .../google/protobuf/LazyMessageLiteTest.java  |  215 +-
 .../protobuf/LazyStringArrayListTest.java     |  159 +-
 .../protobuf/LazyStringEndToEndTest.java      |   66 +-
 .../protobuf/LiteralByteStringTest.java       |  403 +-
 .../google/protobuf/LongArrayListTest.java    |  260 +-
 .../google/protobuf/MapForProto2LiteTest.java |  463 +-
 .../com/google/protobuf/MapForProto2Test.java |  605 +--
 .../java/com/google/protobuf/MapLiteTest.java |  536 +--
 .../java/com/google/protobuf/MapTest.java     |  667 +--
 .../java/com/google/protobuf/MessageTest.java |  198 +-
 .../google/protobuf/NestedBuildersTest.java   |   57 +-
 .../google/protobuf/NioByteStringTest.java    |  444 +-
 .../com/google/protobuf/PackedFieldTest.java  |   24 +-
 .../google/protobuf/ParseExceptionsTest.java  |   13 +-
 .../com/google/protobuf/ParserLiteTest.java   |   80 +-
 .../java/com/google/protobuf/ParserTest.java  |   75 +-
 .../Proto2ExtensionLookupSchemaTest.java      |   51 +-
 .../protobuf/Proto2UnknownEnumValueTest.java  |   60 +-
 .../protobuf/RepeatedFieldBuilderV3Test.java  |  110 +-
 .../protobuf/RopeByteStringSubstringTest.java |   64 +-
 .../google/protobuf/RopeByteStringTest.java   |  123 +-
 .../java/com/google/protobuf/ServiceTest.java |   73 +-
 .../protobuf/SingleFieldBuilderV3Test.java    |   75 +-
 .../google/protobuf/SmallSortedMapTest.java   |  259 +-
 .../protobuf/TestBadIdentifiersLite.java      |   58 +-
 .../java/com/google/protobuf/TestUtil.java    |   13 +-
 .../protobuf/TextFormatParseInfoTreeTest.java |   70 +-
 .../protobuf/TextFormatParseLocationTest.java |   39 +-
 .../com/google/protobuf/TextFormatTest.java   |  782 ++--
 .../com/google/protobuf/TypeRegistryTest.java |   29 +-
 .../google/protobuf/UnknownEnumValueTest.java |  203 +-
 .../google/protobuf/UnknownFieldSetTest.java  |  196 +-
 .../UnmodifiableLazyStringListTest.java       |   94 +-
 .../java/com/google/protobuf/Utf8Test.java    |  102 +-
 .../google/protobuf/WireFormatLiteTest.java   |  233 +-
 .../com/google/protobuf/WireFormatTest.java   |  109 +-
 .../protobuf/WrappersLiteOfMethodTest.java    |   28 +-
 .../google/protobuf/WrappersOfMethodTest.java |   28 +-
 java/kotlin-lite/pom.xml                      |   37 +-
 java/kotlin/pom.xml                           |   78 +-
 .../kotlin/com/google/protobuf/ByteStrings.kt |   50 +
 .../com/google/protobuf/ByteStringsTest.kt    |   97 +
 java/lite/BUILD                               |    1 +
 java/lite/pom.xml                             |    2 +-
 java/lite/pom_template.xml                    |   19 +
 .../java/com/google/protobuf/LiteTest.java    | 1730 ++++----
 java/pom.xml                                  |   19 +-
 java/util/BUILD                               |   20 +-
 java/util/pom.xml                             |    4 +-
 java/util/pom_template.xml                    |   18 +
 .../com/google/protobuf/util/Durations.java   |   20 +
 .../google/protobuf/util/FieldMaskUtil.java   |   17 +
 .../com/google/protobuf/util/TimeUtil.java    |  401 --
 .../com/google/protobuf/util/Timestamps.java  |   20 +
 .../protobuf/util/FieldMaskTreeTest.java      |  115 +-
 .../protobuf/util/FieldMaskUtilTest.java      |  160 +-
 .../google/protobuf/util/JsonFormatTest.java  | 1501 ++++---
 .../com/google/protobuf/util/StructsTest.java |   10 +-
 .../google/protobuf/util/TimeUtilTest.java    |  498 ---
 .../com/google/protobuf/util/ValuesTest.java  |   14 +-
 js/README.md                                  |    9 +-
 kokoro/linux/bazel/build.sh                   |    6 +-
 kokoro/linux/benchmark/build.sh               |   21 -
 kokoro/linux/benchmark/run.sh                 |   92 +-
 .../dockerfile/test/javascript/Dockerfile     |    8 +-
 .../python/windows/build_artifacts.bat        |    2 +
 .../windows/install_python_interpreters.ps1   |   97 +
 objectivec/GPBDescriptor.h                    |    2 +-
 objectivec/README.md                          |   34 +-
 objectivec/Tests/GPBDescriptorTests.m         |   24 +-
 objectivec/Tests/GPBMessageTests.m            |  100 +
 php/ext/google/protobuf/def.c                 |   10 +-
 php/ext/google/protobuf/message.c             |    5 +-
 php/ext/google/protobuf/names.c               |   31 +-
 php/ext/google/protobuf/package.xml           |   58 +-
 php/ext/google/protobuf/protobuf.h            |    2 +-
 php/src/Google/Protobuf/Api.php               |    2 +-
 php/src/Google/Protobuf/Enum.php              |    2 +-
 .../Protobuf/Internal/DescriptorProto.php     |    2 +-
 .../DescriptorProto/ExtensionRange.php        |    2 +-
 .../Protobuf/Internal/EnumDescriptorProto.php |    2 +-
 .../Internal/EnumValueDescriptorProto.php     |    2 +-
 .../Internal/FieldDescriptorProto.php         |    2 +-
 .../Protobuf/Internal/FileDescriptorProto.php |    4 +-
 php/src/Google/Protobuf/Internal/GPBUtil.php  |   19 +-
 .../Internal/MethodDescriptorProto.php        |    2 +-
 .../Internal/OneofDescriptorProto.php         |    2 +-
 .../Internal/ServiceDescriptorProto.php       |    2 +-
 php/src/Google/Protobuf/Option.php            |    2 +-
 php/src/Google/Protobuf/Type.php              |    2 +-
 php/tests/GeneratedClassTest.php              |   26 +
 php/tests/WellKnownTest.php                   |    2 +
 .../proto/test_reserved_enum_lower.proto      |   90 +-
 .../proto/test_reserved_enum_upper.proto      |   90 +-
 .../test_reserved_enum_value_lower.proto      |   90 +-
 .../test_reserved_enum_value_upper.proto      |   90 +-
 .../proto/test_reserved_message_lower.proto   |    4 +
 .../proto/test_reserved_message_upper.proto   |    4 +
 protobuf_deps.bzl                             |    6 +-
 protoc-artifacts/pom.xml                      |   11 +-
 python/README.md                              |    2 -
 .../protobuf/internal/api_implementation.py   |    3 +-
 .../protobuf/internal/more_extensions.proto   |    9 +-
 .../protobuf/internal/proto_builder_test.py   |    9 +-
 python/google/protobuf/proto_api.h            |   21 +
 .../google/protobuf/pyext/descriptor_pool.cc  |   50 +-
 .../google/protobuf/pyext/descriptor_pool.h   |   20 +-
 python/google/protobuf/pyext/message.cc       |  110 +-
 .../google/protobuf/pyext/message_module.cc   |   14 +
 ruby/Rakefile                                 |    1 +
 ruby/ext/google/protobuf_c/defs.c             | 1352 +-----
 ruby/ext/google/protobuf_c/map.c              |    8 +-
 ruby/ext/google/protobuf_c/map.h              |    3 +-
 ruby/ext/google/protobuf_c/message.c          |    8 +-
 ruby/ext/google/protobuf_c/protobuf.c         |   10 +
 ruby/ext/google/protobuf_c/protobuf.h         |    4 +
 ruby/ext/google/protobuf_c/repeated_field.c   |    6 +-
 ruby/ext/google/protobuf_c/repeated_field.h   |    3 +-
 ruby/google-protobuf.gemspec                  |    2 +-
 ruby/lib/google/protobuf.rb                   |   70 +-
 ruby/lib/google/protobuf/descriptor_dsl.rb    |  439 ++
 ruby/tests/basic.rb                           |    7 +
 ruby/travis-test.sh                           |    2 +-
 src/Makefile.am                               |    7 +
 src/README.md                                 |    2 -
 src/google/protobuf/any.pb.cc                 |   61 +-
 src/google/protobuf/any.pb.h                  |    2 +-
 src/google/protobuf/api.pb.cc                 |  217 +-
 src/google/protobuf/api.pb.h                  |    6 +-
 src/google/protobuf/arena.cc                  |   24 +-
 src/google/protobuf/arena.h                   |   16 +-
 src/google/protobuf/arena_impl.h              |   48 +-
 src/google/protobuf/arena_unittest.cc         |   50 +-
 src/google/protobuf/arenastring.h             |   11 +-
 src/google/protobuf/compiler/code_generator.h |    7 +-
 .../protobuf/compiler/cpp/cpp_extension.cc    |   17 +-
 .../protobuf/compiler/cpp/cpp_extension.h     |    6 +-
 src/google/protobuf/compiler/cpp/cpp_field.cc |  186 +-
 src/google/protobuf/compiler/cpp/cpp_field.h  |    9 +
 src/google/protobuf/compiler/cpp/cpp_file.cc  |   43 +-
 src/google/protobuf/compiler/cpp/cpp_file.h   |   13 +-
 .../protobuf/compiler/cpp/cpp_generator.cc    |   52 +-
 .../protobuf/compiler/cpp/cpp_helpers.cc      |   45 +-
 .../protobuf/compiler/cpp/cpp_helpers.h       |   47 +-
 .../protobuf/compiler/cpp/cpp_message.cc      |  809 +++-
 .../protobuf/compiler/cpp/cpp_message.h       |    9 +
 .../protobuf/compiler/cpp/cpp_options.h       |   10 +-
 .../cpp/cpp_parse_function_generator.cc       |  624 +--
 .../cpp/cpp_parse_function_generator.h        |   27 +-
 .../compiler/cpp/cpp_primitive_field.cc       |   17 +-
 .../protobuf/compiler/cpp/cpp_string_field.cc |  186 +-
 .../protobuf/compiler/cpp/cpp_string_field.h  |    2 +
 .../protobuf/compiler/cpp/cpp_unittest.inc    |    2 +
 .../protobuf/compiler/csharp/csharp_enum.cc   |    2 +-
 .../compiler/csharp/csharp_enum_field.h       |   18 +-
 .../compiler/csharp/csharp_field_base.cc      |    2 +-
 .../compiler/csharp/csharp_map_field.h        |   24 +-
 .../compiler/csharp/csharp_message.cc         |    2 +-
 .../compiler/csharp/csharp_message_field.h    |   34 +-
 .../compiler/csharp/csharp_primitive_field.h  |   34 +-
 .../csharp/csharp_reflection_class.cc         |    2 +-
 .../csharp/csharp_repeated_enum_field.h       |   26 +-
 .../csharp/csharp_repeated_message_field.h    |   26 +-
 .../csharp/csharp_repeated_primitive_field.h  |   26 +-
 .../csharp/csharp_source_generator_base.cc    |    5 +-
 .../csharp/csharp_source_generator_base.h     |    3 +-
 .../compiler/csharp/csharp_wrapper_field.h    |   40 +-
 .../compiler/java/java_enum_field_lite.cc     |    7 +-
 .../protobuf/compiler/java/java_message.cc    |    4 +-
 .../compiler/java/java_message_lite.cc        |    4 +-
 .../protobuf/compiler/js/js_generator.cc      |   39 +-
 .../protobuf/compiler/js/js_generator.h       |    3 -
 .../objectivec/objectivec_enum_field.h        |   10 +-
 .../compiler/objectivec/objectivec_field.cc   |    2 +-
 .../compiler/objectivec/objectivec_field.h    |   22 +-
 .../compiler/objectivec/objectivec_file.cc    |   16 +-
 .../compiler/objectivec/objectivec_file.h     |    2 -
 .../objectivec/objectivec_generator.cc        |   51 +-
 .../compiler/objectivec/objectivec_helpers.cc |  283 +-
 .../compiler/objectivec/objectivec_helpers.h  |   23 +-
 .../objectivec/objectivec_map_field.h         |    6 +-
 .../compiler/objectivec/objectivec_message.cc |    2 +-
 .../objectivec/objectivec_message_field.h     |    8 +-
 .../objectivec/objectivec_primitive_field.h   |    6 +-
 .../protobuf/compiler/php/php_generator.cc    |   74 +-
 src/google/protobuf/compiler/plugin.cc        |    1 +
 src/google/protobuf/compiler/plugin.h         |    1 +
 src/google/protobuf/compiler/plugin.pb.cc     |  273 +-
 src/google/protobuf/compiler/plugin.pb.h      |    8 +-
 .../protobuf/compiler/ruby/ruby_generator.cc  |   72 +-
 src/google/protobuf/descriptor.cc             | 1445 ++++---
 src/google/protobuf/descriptor.h              |  253 +-
 src/google/protobuf/descriptor.pb.cc          | 1917 ++++----
 src/google/protobuf/descriptor.pb.h           | 1773 +++++++-
 src/google/protobuf/descriptor_database.cc    |    4 +-
 src/google/protobuf/descriptor_unittest.cc    |   64 +-
 src/google/protobuf/duration.pb.cc            |   59 +-
 src/google/protobuf/duration.pb.h             |    2 +-
 src/google/protobuf/dynamic_message.cc        |  131 +-
 src/google/protobuf/dynamic_message.h         |   16 +-
 src/google/protobuf/empty.pb.cc               |  125 +-
 src/google/protobuf/empty.pb.h                |   33 +-
 src/google/protobuf/extension_set.cc          |  505 ++-
 src/google/protobuf/extension_set.h           |  555 ++-
 src/google/protobuf/extension_set_heavy.cc    |   80 +-
 src/google/protobuf/extension_set_inl.h       |   36 +-
 src/google/protobuf/field_access_listener.cc  |   21 -
 src/google/protobuf/field_access_listener.h   |  324 +-
 src/google/protobuf/field_mask.pb.cc          |   48 +-
 src/google/protobuf/field_mask.pb.h           |    2 +-
 .../protobuf/generated_message_reflection.cc  |  771 ++--
 .../protobuf/generated_message_reflection.h   |   90 +-
 .../generated_message_reflection_unittest.cc  |  239 +-
 .../generated_message_table_driven.cc         |    2 +-
 .../protobuf/generated_message_table_driven.h |   58 +-
 .../generated_message_table_driven_lite.cc    |    2 +-
 .../generated_message_table_driven_lite.h     |  194 +-
 .../protobuf/generated_message_tctable_decl.h |   28 +-
 .../protobuf/generated_message_tctable_impl.h |   44 +-
 .../generated_message_tctable_impl.inc        |  338 +-
 .../generated_message_tctable_lite.cc         |   51 +-
 src/google/protobuf/generated_message_util.cc |  147 +-
 src/google/protobuf/generated_message_util.h  |   25 +-
 src/google/protobuf/has_bits.h                |    6 +-
 src/google/protobuf/implicit_weak_message.h   |    4 +-
 src/google/protobuf/inlined_string_field.cc   |  110 +
 src/google/protobuf/inlined_string_field.h    |  379 ++
 .../protobuf/inlined_string_field_unittest.cc |  286 ++
 src/google/protobuf/io/coded_stream.cc        |  192 +-
 src/google/protobuf/io/coded_stream.h         |  495 ++-
 src/google/protobuf/io/gzip_stream.cc         |    2 +-
 src/google/protobuf/io/gzip_stream.h          |    2 +-
 src/google/protobuf/io/tokenizer.cc           |   34 +-
 src/google/protobuf/io/tokenizer.h            |    4 +-
 .../protobuf/io/zero_copy_stream_impl.cc      |   14 +-
 .../protobuf/io/zero_copy_stream_impl.h       |    2 +-
 .../protobuf/io/zero_copy_stream_impl_lite.cc |   10 +-
 .../protobuf/io/zero_copy_stream_impl_lite.h  |   18 +-
 .../protobuf/io/zero_copy_stream_unittest.cc  |   74 +-
 src/google/protobuf/map.h                     |   29 +-
 src/google/protobuf/map_entry.h               |    4 +-
 src/google/protobuf/map_entry_lite.h          |   27 +-
 src/google/protobuf/map_field.cc              |   30 +-
 src/google/protobuf/map_field.h               |   68 +-
 src/google/protobuf/map_field_inl.h           |   16 +-
 src/google/protobuf/map_field_lite.h          |    6 +-
 src/google/protobuf/map_test.cc               | 3776 +---------------
 src/google/protobuf/map_test.inc              | 3852 +++++++++++++++++
 src/google/protobuf/map_test_util.h           | 1604 +------
 src/google/protobuf/map_type_handler.h        |  169 +-
 src/google/protobuf/message.cc                |  112 +-
 src/google/protobuf/message.h                 |  185 +-
 src/google/protobuf/message_lite.cc           |   22 +-
 src/google/protobuf/message_lite.h            |   10 +-
 src/google/protobuf/parse_context.cc          |   82 +-
 src/google/protobuf/parse_context.h           |  116 +-
 src/google/protobuf/port_def.inc              |   94 +-
 src/google/protobuf/port_undef.inc            |   10 +-
 src/google/protobuf/reflection.h              |   30 +-
 src/google/protobuf/reflection_tester.cc      | 1673 +++++++
 src/google/protobuf/reflection_tester.h       |  122 +
 src/google/protobuf/repeated_field.cc         |   16 +-
 src/google/protobuf/repeated_field.h          |   52 +-
 .../protobuf/repeated_field_unittest.cc       |   11 +-
 src/google/protobuf/source_context.pb.cc      |   54 +-
 src/google/protobuf/source_context.pb.h       |    2 +-
 src/google/protobuf/string_member_robber.h    |   38 +
 src/google/protobuf/struct.pb.cc              |  162 +-
 src/google/protobuf/struct.pb.h               |    6 +-
 src/google/protobuf/stubs/stl_util.h          |   14 +
 .../protobuf/test_messages_proto2.proto       |   10 +
 .../protobuf/test_messages_proto3.proto       |   10 +
 src/google/protobuf/test_util.h               |    7 -
 src/google/protobuf/text_format.cc            |  114 +-
 src/google/protobuf/text_format.h             |   60 +-
 src/google/protobuf/text_format_unittest.cc   |   51 +-
 src/google/protobuf/timestamp.pb.cc           |   59 +-
 src/google/protobuf/timestamp.pb.h            |    2 +-
 src/google/protobuf/type.pb.cc                |  357 +-
 src/google/protobuf/type.pb.h                 |   10 +-
 src/google/protobuf/unittest.proto            |    1 +
 src/google/protobuf/unknown_field_set.cc      |   24 +-
 src/google/protobuf/unknown_field_set.h       |   50 +-
 .../protobuf/util/message_differencer.cc      |  117 +-
 .../protobuf/util/message_differencer.h       |   10 +-
 src/google/protobuf/wire_format.cc            |  225 +-
 src/google/protobuf/wire_format.h             |   56 +-
 src/google/protobuf/wire_format_lite.cc       |  126 +-
 src/google/protobuf/wire_format_lite.h        | 1008 +++--
 src/google/protobuf/wire_format_unittest.cc   | 1544 +------
 src/google/protobuf/wire_format_unittest.inc  | 1585 +++++++
 src/google/protobuf/wrappers.pb.cc            |  460 +-
 src/google/protobuf/wrappers.pb.h             |   18 +-
 tests.sh                                      |   11 +-
 update_version.py                             |    8 +
 355 files changed, 30126 insertions(+), 23804 deletions(-)
 create mode 100644 java/core/pom_template.xml
 create mode 100644 java/kotlin/src/main/kotlin/com/google/protobuf/ByteStrings.kt
 create mode 100644 java/kotlin/src/test/kotlin/com/google/protobuf/ByteStringsTest.kt
 create mode 100644 java/lite/pom_template.xml
 create mode 100644 java/util/pom_template.xml
 delete mode 100644 java/util/src/main/java/com/google/protobuf/util/TimeUtil.java
 delete mode 100644 java/util/src/test/java/com/google/protobuf/util/TimeUtilTest.java
 create mode 100644 kokoro/release/python/windows/install_python_interpreters.ps1
 create mode 100644 ruby/lib/google/protobuf/descriptor_dsl.rb
 create mode 100644 src/google/protobuf/inlined_string_field.cc
 create mode 100644 src/google/protobuf/inlined_string_field.h
 create mode 100644 src/google/protobuf/inlined_string_field_unittest.cc
 create mode 100644 src/google/protobuf/map_test.inc
 create mode 100644 src/google/protobuf/reflection_tester.cc
 create mode 100644 src/google/protobuf/reflection_tester.h
 create mode 100644 src/google/protobuf/string_member_robber.h
 create mode 100644 src/google/protobuf/wire_format_unittest.inc

Index: protobuf-3.12.4/java/core/src/main/java/com/google/protobuf/CodedInputStream.java
===================================================================
--- protobuf-3.12.4.orig/java/core/src/main/java/com/google/protobuf/CodedInputStream.java
+++ protobuf-3.12.4/java/core/src/main/java/com/google/protobuf/CodedInputStream.java
@@ -60,14 +60,14 @@ import java.util.List;
  */
 public abstract class CodedInputStream {
   private static final int DEFAULT_BUFFER_SIZE = 4096;
-  private static final int DEFAULT_RECURSION_LIMIT = 100;
   // Integer.MAX_VALUE == 0x7FFFFFF == INT_MAX from limits.h
   private static final int DEFAULT_SIZE_LIMIT = Integer.MAX_VALUE;
+  private static volatile int defaultRecursionLimit = 100;
 
   /** Visible for subclasses. See setRecursionLimit() */
   int recursionDepth;
 
-  int recursionLimit = DEFAULT_RECURSION_LIMIT;
+  int recursionLimit = defaultRecursionLimit;
 
   /** Visible for subclasses. See setSizeLimit() */
   int sizeLimit = DEFAULT_SIZE_LIMIT;
@@ -194,6 +194,11 @@ public abstract class CodedInputStream {
     return newInstance(buffer, 0, buffer.length, true);
   }
 
+  public void checkRecursionLimit() throws InvalidProtocolBufferException {
+    if (recursionDepth >= recursionLimit) {
+      throw InvalidProtocolBufferException.recursionLimitExceeded();
+    }
+  }
   /** Disable construction/inheritance outside of this class. */
   private CodedInputStream() {}
 
@@ -826,9 +831,7 @@ public abstract class CodedInputStream {
         final MessageLite.Builder builder,
         final ExtensionRegistryLite extensionRegistry)
         throws IOException {
-      if (recursionDepth >= recursionLimit) {
-        throw InvalidProtocolBufferException.recursionLimitExceeded();
-      }
+      checkRecursionLimit();
       ++recursionDepth;
       builder.mergeFrom(this, extensionRegistry);
       checkLastTagWas(WireFormat.makeTag(fieldNumber, WireFormat.WIRETYPE_END_GROUP));
@@ -842,9 +845,7 @@ public abstract class CodedInputStream {
         final Parser<T> parser,
         final ExtensionRegistryLite extensionRegistry)
         throws IOException {
-      if (recursionDepth >= recursionLimit) {
-        throw InvalidProtocolBufferException.recursionLimitExceeded();
-      }
+      checkRecursionLimit();
       ++recursionDepth;
       T result = parser.parsePartialFrom(this, extensionRegistry);
       checkLastTagWas(WireFormat.makeTag(fieldNumber, WireFormat.WIRETYPE_END_GROUP));
@@ -864,9 +865,7 @@ public abstract class CodedInputStream {
         final MessageLite.Builder builder, final ExtensionRegistryLite extensionRegistry)
         throws IOException {
       final int length = readRawVarint32();
-      if (recursionDepth >= recursionLimit) {
-        throw InvalidProtocolBufferException.recursionLimitExceeded();
-      }
+      checkRecursionLimit();
       final int oldLimit = pushLimit(length);
       ++recursionDepth;
       builder.mergeFrom(this, extensionRegistry);
@@ -880,9 +879,7 @@ public abstract class CodedInputStream {
     public <T extends MessageLite> T readMessage(
         final Parser<T> parser, final ExtensionRegistryLite extensionRegistry) throws IOException {
       int length = readRawVarint32();
-      if (recursionDepth >= recursionLimit) {
-        throw InvalidProtocolBufferException.recursionLimitExceeded();
-      }
+      checkRecursionLimit();
       final int oldLimit = pushLimit(length);
       ++recursionDepth;
       T result = parser.parsePartialFrom(this, extensionRegistry);
@@ -1545,9 +1542,7 @@ public abstract class CodedInputStream {
         final MessageLite.Builder builder,
         final ExtensionRegistryLite extensionRegistry)
         throws IOException {
-      if (recursionDepth >= recursionLimit) {
-        throw InvalidProtocolBufferException.recursionLimitExceeded();
-      }
+      checkRecursionLimit();
       ++recursionDepth;
       builder.mergeFrom(this, extensionRegistry);
       checkLastTagWas(WireFormat.makeTag(fieldNumber, WireFormat.WIRETYPE_END_GROUP));
@@ -1561,9 +1556,7 @@ public abstract class CodedInputStream {
         final Parser<T> parser,
         final ExtensionRegistryLite extensionRegistry)
         throws IOException {
-      if (recursionDepth >= recursionLimit) {
-        throw InvalidProtocolBufferException.recursionLimitExceeded();
-      }
+      checkRecursionLimit();
       ++recursionDepth;
       T result = parser.parsePartialFrom(this, extensionRegistry);
       checkLastTagWas(WireFormat.makeTag(fieldNumber, WireFormat.WIRETYPE_END_GROUP));
@@ -1583,9 +1576,7 @@ public abstract class CodedInputStream {
         final MessageLite.Builder builder, final ExtensionRegistryLite extensionRegistry)
         throws IOException {
       final int length = readRawVarint32();
-      if (recursionDepth >= recursionLimit) {
-        throw InvalidProtocolBufferException.recursionLimitExceeded();
-      }
+      checkRecursionLimit();
       final int oldLimit = pushLimit(length);
       ++recursionDepth;
       builder.mergeFrom(this, extensionRegistry);
@@ -1599,9 +1590,7 @@ public abstract class CodedInputStream {
     public <T extends MessageLite> T readMessage(
         final Parser<T> parser, final ExtensionRegistryLite extensionRegistry) throws IOException {
       int length = readRawVarint32();
-      if (recursionDepth >= recursionLimit) {
-        throw InvalidProtocolBufferException.recursionLimitExceeded();
-      }
+      checkRecursionLimit();
       final int oldLimit = pushLimit(length);
       ++recursionDepth;
       T result = parser.parsePartialFrom(this, extensionRegistry);
@@ -2304,9 +2293,7 @@ public abstract class CodedInputStream {
         final MessageLite.Builder builder,
         final ExtensionRegistryLite extensionRegistry)
         throws IOException {
-      if (recursionDepth >= recursionLimit) {
-        throw InvalidProtocolBufferException.recursionLimitExceeded();
-      }
+      checkRecursionLimit();
       ++recursionDepth;
       builder.mergeFrom(this, extensionRegistry);
       checkLastTagWas(WireFormat.makeTag(fieldNumber, WireFormat.WIRETYPE_END_GROUP));
@@ -2320,9 +2307,7 @@ public abstract class CodedInputStream {
         final Parser<T> parser,
         final ExtensionRegistryLite extensionRegistry)
         throws IOException {
-      if (recursionDepth >= recursionLimit) {
-        throw InvalidProtocolBufferException.recursionLimitExceeded();
-      }
+      checkRecursionLimit();
       ++recursionDepth;
       T result = parser.parsePartialFrom(this, extensionRegistry);
       checkLastTagWas(WireFormat.makeTag(fieldNumber, WireFormat.WIRETYPE_END_GROUP));
@@ -2342,9 +2327,7 @@ public abstract class CodedInputStream {
         final MessageLite.Builder builder, final ExtensionRegistryLite extensionRegistry)
         throws IOException {
       final int length = readRawVarint32();
-      if (recursionDepth >= recursionLimit) {
-        throw InvalidProtocolBufferException.recursionLimitExceeded();
-      }
+      checkRecursionLimit();
       final int oldLimit = pushLimit(length);
       ++recursionDepth;
       builder.mergeFrom(this, extensionRegistry);
@@ -2358,9 +2341,7 @@ public abstract class CodedInputStream {
     public <T extends MessageLite> T readMessage(
         final Parser<T> parser, final ExtensionRegistryLite extensionRegistry) throws IOException {
       int length = readRawVarint32();
-      if (recursionDepth >= recursionLimit) {
-        throw InvalidProtocolBufferException.recursionLimitExceeded();
-      }
+      checkRecursionLimit();
       final int oldLimit = pushLimit(length);
       ++recursionDepth;
       T result = parser.parsePartialFrom(this, extensionRegistry);
@@ -3400,9 +3381,7 @@ public abstract class CodedInputStream {
         final MessageLite.Builder builder,
         final ExtensionRegistryLite extensionRegistry)
         throws IOException {
-      if (recursionDepth >= recursionLimit) {
-        throw InvalidProtocolBufferException.recursionLimitExceeded();
-      }
+      checkRecursionLimit();
       ++recursionDepth;
       builder.mergeFrom(this, extensionRegistry);
       checkLastTagWas(WireFormat.makeTag(fieldNumber, WireFormat.WIRETYPE_END_GROUP));
@@ -3416,9 +3395,7 @@ public abstract class CodedInputStream {
         final Parser<T> parser,
         final ExtensionRegistryLite extensionRegistry)
         throws IOException {
-      if (recursionDepth >= recursionLimit) {
-        throw InvalidProtocolBufferException.recursionLimitExceeded();
-      }
+      checkRecursionLimit();
       ++recursionDepth;
       T result = parser.parsePartialFrom(this, extensionRegistry);
       checkLastTagWas(WireFormat.makeTag(fieldNumber, WireFormat.WIRETYPE_END_GROUP));
@@ -3438,9 +3415,7 @@ public abstract class CodedInputStream {
         final MessageLite.Builder builder, final ExtensionRegistryLite extensionRegistry)
         throws IOException {
       final int length = readRawVarint32();
-      if (recursionDepth >= recursionLimit) {
-        throw InvalidProtocolBufferException.recursionLimitExceeded();
-      }
+      checkRecursionLimit();
       final int oldLimit = pushLimit(length);
       ++recursionDepth;
       builder.mergeFrom(this, extensionRegistry);
@@ -3454,9 +3429,7 @@ public abstract class CodedInputStream {
     public <T extends MessageLite> T readMessage(
         final Parser<T> parser, final ExtensionRegistryLite extensionRegistry) throws IOException {
       int length = readRawVarint32();
-      if (recursionDepth >= recursionLimit) {
-        throw InvalidProtocolBufferException.recursionLimitExceeded();
-      }
+      checkRecursionLimit();
       final int oldLimit = pushLimit(length);
       ++recursionDepth;
       T result = parser.parsePartialFrom(this, extensionRegistry);
